# üá∑üá∫ Zabbix 7.4 –≤ Docker + PSK –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤ üê≥üîí

**UI FQDN:** `yourdomain.com`  

---

## üì¶ –°–æ—Å—Ç–∞–≤ –ø—Ä–æ–µ–∫—Ç–∞

- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** PostgreSQL 17 (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- **Zabbix Server:** `zabbix/zabbix-server-pgsql:alpine-7.4-latest`
- **Zabbix Web:** `zabbix/zabbix-web-nginx-pgsql:alpine-7.4-latest`
- **Nginx:** TLS-—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏—è
- **PSK –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤:** –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π –∫–ª—é—á (PSK)

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**

   ```shell
   cp .env.example .env
   # –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ .env
   ```

2. **–°–æ–∑–¥–∞–π—Ç–µ PSK –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤:**

   ```shell
   openssl rand -hex 32 > /opt/zabbix/ssl/zabbix_agentd.psk
   # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π –ø—É—Ç—å, –Ω–æ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª!
   ```

3. **–ó–∞–ø—É—Å–∫ —Å—Ç–µ–∫–∞:**

   ```shell
   docker compose up -d
   ```

4. **–û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**  
   [https://yourdomain.com](https://yourdomain.com)

---

## üñ•Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ö–æ—Å—Ç–∞ Zabbix (PSK)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞ –≤ Zabbix ‚Üí **Encryption**:

- Connections to host: **PSK**
- PSK identity: —Å—Ç—Ä–æ–∫–∞-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, `zabbix-psk`)
- PSK: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `/opt/zabbix/ssl/zabbix_agentd.psk` (–∏–ª–∏ –≤–∞—à–µ–≥–æ –ø—É—Ç–∏)

---

## üêß –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ –∞–≥–µ–Ω—Ç–∞ (Linux, PSK)

```ini
Server=<IP_–∏–ª–∏_FQDN_—Å–µ—Ä–≤–µ—Ä–∞_Zabbix>
ServerActive=<IP_–∏–ª–∏_FQDN_—Å–µ—Ä–≤–µ—Ä–∞_Zabbix>
TLSConnect=psk
TLSAccept=psk
TLSPSKIdentity=zabbix-psk
TLSPSKFile=/etc/zabbix/zabbix_agentd.psk
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏ PSK-—Ñ–∞–π–ª—ã
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ `chmod 600` –Ω–∞ PSK-—Ñ–∞–π–ª—ã
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–π—Ç–µ PSK –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –æ–¥–Ω—É —Å–µ—Ç—å `zbx-net`
- –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è volume `zbx-pgdata`
- PSK-—Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—â–∏—â–µ–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```
   cp .env.example .env
   # –£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î –∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤ .env
   ```

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSR –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ—Ç Windows-CA:**
   ```bash
   ./scripts/gen_server_csr.sh
   # –û—Ç–ø—Ä–∞–≤—å—Ç–µ tls/server.csr.pem –Ω–∞ –í–∞—à CA (—à–∞–±–ª–æ–Ω: Web Server)
   # –ü–æ–º–µ—Å—Ç–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
   #   secrets/server/server.crt.pem
   #   secrets/server/server.key.pem  (–∏–∑ tls/server.key.pem)
   #   secrets/server/server.fullchain.pem  (—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç + —Ü–µ–ø–æ—á–∫–∞)
   ```
   *–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∏–∑ PFX:*
   ```bash
   openssl pkcs12 -in server.pfx -nocerts -nodes -out tls/server.key.pem
   openssl pkcs12 -in server.pfx -clcerts -nokeys -out tls/server.crt.pem
   openssl pkcs12 -in server.pfx -cacerts -nokeys -out tls/chain.pem
   cat tls/server.crt.pem tls/chain.pem > secrets/server/server.fullchain.pem
   cp tls/server.crt.pem secrets/server/server.crt.pem
   cp tls/server.key.pem secrets/server/server.key.pem
   chmod 600 secrets/server/server.key.pem
   ```

3. **–°–æ–∑–¥–∞–π—Ç–µ PSK –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤:**
   ```bash
   openssl rand -hex 32 > /opt/zabbix/ssl/zabbix_agentd.psk
   # –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π –ø—É—Ç—å, –Ω–æ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª!
   ```

4. **–ó–∞–ø—É—Å–∫ —Å—Ç–µ–∫–∞:**
   ```bash
   docker compose up -d
   ```

5. **–û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:**  
   [https://yourdomain.com](https://yourdomain.com)

---

## üñ•Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ö–æ—Å—Ç–∞ Zabbix (PSK)

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ—Å—Ç–∞ –≤ Zabbix ‚Üí **Encryption**:
- Connections to host: **PSK**
- PSK identity: —Å—Ç—Ä–æ–∫–∞-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, `zabbix-psk`)
- PSK: —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `/opt/zabbix/ssl/zabbix_agentd.psk` (–∏–ª–∏ –≤–∞—à–µ–≥–æ –ø—É—Ç–∏)

---

## üêß –ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥–∞ –∞–≥–µ–Ω—Ç–∞ (Linux, PSK)

```
Server=<IP_–∏–ª–∏_FQDN_—Å–µ—Ä–≤–µ—Ä–∞_Zabbix>
ServerActive=<IP_–∏–ª–∏_FQDN_—Å–µ—Ä–≤–µ—Ä–∞_Zabbix>
TLSConnect=psk
TLSAccept=psk
TLSPSKIdentity=zabbix-psk
TLSPSKFile=/etc/zabbix/zabbix_agentd.psk
```

---

## üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (—Å–æ —Å—Ç–∞—Ä–æ–π systemd-—É—Å—Ç–∞–Ω–æ–≤–∫–∏)

**–≠–∫—Å–ø–æ—Ä—Ç –Ω–∞ —Å—Ç–∞—Ä–æ–º —Å–µ—Ä–≤–µ—Ä–µ:**
```
./scripts/export_old_zabbix_pg.sh --dir backups
```
**–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ:**  
–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Postgres ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ `scripts/restore_zabbix_pg.sh`.

---

## ‚ö†Ô∏è –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è ZBX_TLS* –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ override-—Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞:
- –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `conf/zabbix_server.extra.conf.example` –∏ —Å–º–æ–Ω—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –∫–∞–∫ `/etc/zabbix/zabbix_server.conf` –≤ `docker-compose.yml`, –ø–ª—é—Å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ë–î.
- –û—Å—Ç–∞–≤—å—Ç–µ volume –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤/–∫–ª—é—á–µ–π –∫–∞–∫ –≤ compose.

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `secrets/`, `.env`, –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏ PSK-—Ñ–∞–π–ª—ã.
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ `chmod 600` –Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏ PSK.
- –ú–µ–Ω—è–π—Ç–µ PSK –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ –æ–¥–Ω—É —Å–µ—Ç—å `zbx-net`.
- –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Postgres –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è volume `zbx-pgdata`.
- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤ –ø–∞–ø–∫–µ `secrets/` —Å–æ–≥–ª–∞—Å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.
- –î–ª—è —Ä–∞–±–æ—Ç—ã —Å TLS (UI) –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –∫–ª—é—á–∏.
